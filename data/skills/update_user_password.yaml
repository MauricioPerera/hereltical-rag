id: update_user_password
name: Update User Password
type: skill
category: crud
tags:
  - users
  - security
  - authentication
  - password
  - crud
version: "1.0.0"

usesTools:
  - db_query

overview: |
  Actualiza el password de un usuario en la tabla users.
  Valida password actual, hashea nuevo password con bcrypt.
  Invalida sesiones activas para forzar re-login.

instructions:
  steps:
    - Validar que userId existe y no esta eliminado
    - Si se requiere, verificar password actual con bcrypt.compare()
    - Validar fortaleza del nuevo password (minimo 8 chars, mayusculas, numeros, simbolos)
    - Hashear nuevo password con bcrypt (10 rounds)
    - Preparar query UPDATE users SET password_hash = ?, updated_at = NOW() WHERE id = ?
    - Ejecutar db_query tool con prepared statement
    - Verificar que affectedRows = 1
    - Invalidar todas las sesiones activas del usuario (force re-login)
    - Loguear cambio de password (sin incluir passwords)
    - Opcionalmente enviar email de confirmacion
    - Retornar confirmacion exitosa
  
  prerequisites:
    - Tabla users existe con columna password_hash
    - Usuario existe y no esta eliminado
    - Libreria bcrypt disponible para hashing y comparacion
    - Tabla sessions para invalidar sesiones activas
  
  bestPractices:
    - Validar password actual antes de permitir cambio
    - Verificar fortaleza del nuevo password (OWASP guidelines)
    - Hashear con bcrypt (minimo 10 rounds)
    - Invalidar sesiones para forzar re-login
    - Enviar email de notificacion de cambio de password
    - Loguear cambio con IP y timestamp para auditoria
    - Considerar rate limiting (prevenir brute force)
  
  antiPatterns:
    - NO permitir cambio sin verificar password actual
    - NO aceptar passwords debiles
    - NO almacenar password en texto plano
    - NO olvidar actualizar updated_at
    - NO permitir cambio sin autenticacion previa
    - NO loguear passwords (ni viejo ni nuevo)

parameters:
  - name: userId
    type: number
    required: true
    description: ID del usuario
  
  - name: currentPassword
    type: string
    required: true
    description: Password actual (para verificacion)
  
  - name: newPassword
    type: string
    required: true
    description: Nuevo password (sera hasheado)
  
  - name: invalidateSessions
    type: boolean
    required: false
    description: Invalidar sesiones activas
    default: true

outputs:
  - name: success
    type: boolean
    description: true si password fue actualizado
  
  - name: userId
    type: number
    description: ID del usuario actualizado
  
  - name: updatedAt
    type: string
    description: Timestamp de actualizacion

examples:
  - situation: Cambio de password exitoso
    input:
      userId: 42
      currentPassword: OldPass123!
      newPassword: NewSecurePass456!
    expectedOutput: |
      { success: true, userId: 42, updatedAt: 2024-01-15T10:30:00Z }
    notes: Sesiones activas invalidadas, email de confirmacion enviado
  
  - situation: Error por password actual incorrecto
    input:
      userId: 42
      currentPassword: WrongPassword
      newPassword: NewPass789!
    expectedOutput: |
      ERROR: Current password is incorrect
    notes: bcrypt.compare() retorno false
  
  - situation: Error por password nuevo muy debil
    input:
      userId: 42
      currentPassword: OldPass123!
      newPassword: weak
    expectedOutput: |
      ERROR: New password does not meet strength requirements
    notes: Debe tener minimo 8 chars, mayusculas, numeros

errorHandling:
  commonErrors:
    - "Current password incorrect - bcrypt.compare() fallo"
    - "Password too weak - No cumple requisitos de seguridad"
    - "User not found - userId no existe o esta eliminado"
    - "Database timeout - Query tardo mas de 5 segundos"
  
  recovery:
    - Para password incorrecto - Limitar intentos (rate limit)
    - Para password debil - Mostrar requisitos claros al usuario
    - Para usuario inexistente - Verificar userId antes de intentar
    - Para timeout - Verificar indices y performance de DB

